generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  super_admin
  admin
  mentor
  founder
  co_founder
}

enum BatchStatus {
  active
  archived
}

enum UserBatchStatus {
  invited
  active
}

enum QuestionStatus {
  open
  closed
}

enum OfficeHourSlotStatus {
  available
  requested
  confirmed
  completed
  cancelled
}

enum OfficeHourRequestStatus {
  pending
  approved
  rejected
  cancelled
}

enum LikeTargetType {
  post
  comment
}

enum EventType {
  one_off
  office_hour
  in_person
}

// ============================================
// MODELS
// ============================================

// 1. User - Core user model
model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  name          String?
  role          UserRole? @default(founder) @map("global_role")
  linkedinId    String?   @unique @map("linkedin_id")
  profileImage  String?   @map("profile_image")
  jobTitle      String?   @map("job_title") @db.VarChar(100)
  company       String?   @db.VarChar(100)
  bio           String?   @db.VarChar(500)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  headline       String? @db.VarChar(200)
  followerCount  Int     @default(0) @map("follower_count")
  followingCount Int     @default(0) @map("following_count")
  // M2: New profile fields
  location      String?  @db.VarChar(200)
  linkedinUrl   String?  @map("linkedin_url") @db.VarChar(500)
  twitterUrl    String?  @map("twitter_url") @db.VarChar(500)
  websiteUrl    String?  @map("website_url") @db.VarChar(500)
  // Relations
  userBatches         UserBatch[]
  coFounderAssignments UserBatch[] @relation("CoFounderOf")
  questions           Question[]
  answers             Answer[]
  summaries           Summary[]
  officeHourSlots     OfficeHourSlot[]
  officeHourRequests  OfficeHourRequest[]
  submissions         Submission[]
  feedbacks           Feedback[]
  posts               Post[]
  comments            Comment[]
  likes               Like[]
  events              Event[]
  groups              Group[]
  groupMembers        GroupMember[]
  following           UserFollow[] @relation("Following")
  followers           UserFollow[] @relation("Followers")
  bookmarks           Bookmark[]
  postViews           PostView[]
  // M2: New relations
  companyMemberships CompanyMember[]
  experiences        Experience[]
  education          Education[]
  // M3: Messaging relations
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  createdConversations     Conversation[] @relation("ConversationCreator")
  @@map("users")
}

// 2. Batch - Program cohort
model Batch {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @db.VarChar(100)
  description String?     @db.Text
  startDate   DateTime    @map("start_date") @db.Date
  endDate     DateTime    @map("end_date") @db.Date
  status      BatchStatus @default(active)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  userBatches      UserBatch[]
  questions        Question[]
  officeHourSlots  OfficeHourSlot[]
  sessions         Session[]
  assignments      Assignment[]
  posts            Post[]
  events           Event[]
  groups           Group[]

  @@map("batches")
}

// 3. UserBatch - User-Batch relationship
model UserBatch {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  batchId   String          @map("batch_id") @db.Uuid
  role      UserRole
  founderId String?         @map("founder_id") @db.Uuid // For co-founders: links to their main founder
  invitedAt DateTime        @default(now()) @map("invited_at")
  joinedAt  DateTime?       @map("joined_at")
  status    UserBatchStatus @default(invited)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  batch  Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  founder User?  @relation("CoFounderOf", fields: [founderId], references: [id], onDelete: SetNull)

  @@unique([userId, batchId])
  @@index([userId, status])
  @@index([batchId, status])
  @@index([founderId]) // Index for co-founder lookups
  @@map("user_batches")
}

// 4. Question - Founder questions
model Question {
  id        String         @id @default(uuid()) @db.Uuid
  batchId   String         @map("batch_id") @db.Uuid
  authorId  String         @map("author_id") @db.Uuid
  title     String         @db.VarChar(200)
  content   String         @db.Text
  status    QuestionStatus @default(open)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  // Relations
  batch       Batch                  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  author      User                   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  attachments QuestionAttachment[]
  answers     Answer[]
  summary     Summary?

  @@index([batchId, status])
  @@index([batchId, createdAt])
  @@index([authorId])
  @@map("questions")
}

// 5. QuestionAttachment - Question file attachments
model QuestionAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  fileUrl    String   @map("file_url")
  fileName   String   @map("file_name")
  fileSize   Int      @map("file_size")
  fileType   String   @map("file_type")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_attachments")
}

// 6. Answer - Mentor/Admin answers
model Answer {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  authorId   String   @map("author_id") @db.Uuid
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  author   User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("answers")
}

// 7. Summary - Admin summary (closes question)
model Summary {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @unique @map("question_id") @db.Uuid
  authorId   String   @map("author_id") @db.Uuid
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  author   User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("summaries")
}

// 8. OfficeHourSlot - Mentor/Admin office hour slots
model OfficeHourSlot {
  id             String               @id @default(uuid()) @db.Uuid
  batchId        String               @map("batch_id") @db.Uuid
  hostId         String               @map("host_id") @db.Uuid
  startTime      DateTime             @map("start_time")
  endTime        DateTime             @map("end_time")
  timezone       String               @default("UTC") @db.VarChar(50)
  status         OfficeHourSlotStatus @default(available)
  googleMeetLink String?              @map("google_meet_link")
  googleEventId  String?              @map("google_event_id")
  createdAt      DateTime             @default(now()) @map("created_at")

  groupId        String?              @map("group_id") @db.Uuid

  // Relations
  batch    Batch               @relation(fields: [batchId], references: [id], onDelete: Cascade)
  host     User                @relation(fields: [hostId], references: [id], onDelete: Cascade)
  group    Group?              @relation(fields: [groupId], references: [id], onDelete: SetNull)
  requests OfficeHourRequest[]

  @@index([batchId, startTime, status])
  @@index([hostId])
  @@index([groupId])
  @@map("office_hour_slots")
}

// 9. OfficeHourRequest - Founder requests for office hours
model OfficeHourRequest {
  id          String                   @id @default(uuid()) @db.Uuid
  slotId      String                   @map("slot_id") @db.Uuid
  requesterId String                   @map("requester_id") @db.Uuid
  message     String?                  @db.Text
  status      OfficeHourRequestStatus  @default(pending)
  createdAt   DateTime                 @default(now()) @map("created_at")
  respondedAt DateTime?                @map("responded_at")

  // Relations
  slot      OfficeHourSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  requester User           @relation(fields: [requesterId], references: [id], onDelete: Cascade)

  @@map("office_hour_requests")
}

// 10. Session - Program sessions
model Session {
  id            String    @id @default(uuid()) @db.Uuid
  batchId       String    @map("batch_id") @db.Uuid
  title         String    @db.VarChar(200)
  description   String?   @db.Text
  sessionDate   DateTime  @map("session_date") @db.Date
  startTime     DateTime? @map("start_time")
  endTime       DateTime? @map("end_time")
  timezone      String    @default("UTC")
  slidesUrl     String?   @map("slides_url")
  recordingUrl  String?   @map("recording_url")
  googleEventId String?   @map("google_event_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  batch Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// 11. Assignment - Founder assignments
model Assignment {
  id          String   @id @default(uuid()) @db.Uuid
  batchId     String   @map("batch_id") @db.Uuid
  title       String   @db.VarChar(200)
  description String   @db.Text
  templateUrl String?  @map("template_url")
  dueDate     DateTime @map("due_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  batch       Batch        @relation(fields: [batchId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([batchId, dueDate])
  @@map("assignments")
}

// 12. Submission - Assignment submissions
model Submission {
  id           String   @id @default(uuid()) @db.Uuid
  assignmentId String   @map("assignment_id") @db.Uuid
  authorId     String   @map("author_id") @db.Uuid
  content      String?  @db.Text
  linkUrl      String?  @map("link_url")
  isLate       Boolean  @default(false) @map("is_late")
  submittedAt  DateTime @default(now()) @map("submitted_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  feedbacks  Feedback[]

  @@unique([assignmentId, authorId])
  @@index([assignmentId])
  @@map("submissions")
}

// 13. Feedback - Submission feedback
model Feedback {
  id           String   @id @default(uuid()) @db.Uuid
  submissionId String   @map("submission_id") @db.Uuid
  authorId     String   @map("author_id") @db.Uuid
  content      String   @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("feedbacks")
}

// 14. Event - Batch events
model Event {
  id            String    @id @default(uuid()) @db.Uuid
  batchId       String    @map("batch_id") @db.Uuid
  creatorId     String    @map("creator_id") @db.Uuid
  title         String    @db.VarChar(200)
  description   String?   @db.Text
  eventType     EventType @map("event_type")
  startTime     DateTime  @map("start_time")
  endTime       DateTime  @map("end_time")
  timezone      String    @default("UTC") @db.VarChar(50)
  location      String?   @db.VarChar(500)
  googleEventId String?   @map("google_event_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  batch   Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  creator User  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([batchId, startTime])
  @@map("events")
}

// 15. Group - Founder groups
model Group {
  id          String   @id @default(uuid()) @db.Uuid
  batchId     String   @map("batch_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  batch           Batch              @relation(fields: [batchId], references: [id], onDelete: Cascade)
  creator         User               @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  members         GroupMember[]
  posts           Post[]
  officeHourSlots OfficeHourSlot[]

  @@map("groups")
}

// 16. GroupMember - Group membership
model GroupMember {
  id       String   @id @default(uuid()) @db.Uuid
  groupId  String   @map("group_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

// 17. Post - Community posts
model Post {
  id        String   @id @default(uuid()) @db.Uuid
  batchId   String   @map("batch_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  groupId   String?  @map("group_id") @db.Uuid
  content   String   @db.Text
  isPinned  Boolean  @default(false) @map("is_pinned")
  isHidden  Boolean  @default(false) @map("is_hidden")
  category    String?  @db.VarChar(50)
  viewCount   Int      @default(0) @map("view_count")
  linkPreview Json?    @map("link_preview")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  batch    Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  author   User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  group    Group?      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  images   PostImage[]
  comments Comment[]
  likes    Like[]
  bookmarks Bookmark[]
  views     PostView[]

  @@index([batchId, category, isPinned, createdAt])
  @@index([batchId, groupId])
  @@map("posts")
}

// 18. PostImage - Post images
model PostImage {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_images")
}

// 19. Comment - Post comments
model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  post     Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes    Like[]

  @@index([postId, parentId])
  @@map("comments")
}

// 20. Like - Post/Comment likes
model Like {
  id         String         @id @default(uuid()) @db.Uuid
  userId     String         @map("user_id") @db.Uuid
  targetType LikeTargetType @map("target_type")
  postId     String?        @map("post_id") @db.Uuid
  commentId  String?        @map("comment_id") @db.Uuid
  createdAt  DateTime       @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, postId, commentId])
  @@index([postId])
  @@index([commentId])
  @@map("likes")
}

// 22. InvitationToken - Secure invitation links
model InvitationToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique
  userId    String    @map("user_id") @db.Uuid
  batchId   String    @map("batch_id") @db.Uuid
  email     String
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("invitation_tokens")
}

model UserFollow {
  id          String   @id @default(uuid()) @db.Uuid
  followerId  String   @map("follower_id") @db.Uuid
  followingId String   @map("following_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  follower  User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

model Bookmark {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("bookmarks")
}

model PostView {
  id        String   @id @default(uuid()) @db.Uuid
  postId    String   @map("post_id") @db.Uuid
  viewerId  String   @map("viewer_id") @db.Uuid
  viewedAt  DateTime @default(now()) @map("viewed_at") @db.Date

  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  viewer User @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([postId, viewerId, viewedAt])
  @@index([postId])
  @@index([viewerId])
  @@map("post_views")
}


// ============================================
// M2: DIRECTORY + PROFILES MODELS
// ============================================

// Company - Standalone company entity
model Company {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(200)
  slug        String   @unique @db.VarChar(200)
  description String?  @db.Text
  website     String?  @db.VarChar(500)
  industry    String?  @db.VarChar(100)
  hqLocation  String?  @map("hq_location") @db.VarChar(200)
  foundedYear Int?     @map("founded_year")
  logoUrl     String?  @map("logo_url")
  tags        String[] @default([])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  members     CompanyMember[]

  @@index([industry])
  @@index([hqLocation])
  @@map("companies")
}

// CompanyMember - Junction table for Company <-> User
model CompanyMember {
  id         String    @id @default(uuid()) @db.Uuid
  companyId  String    @map("company_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  role       String?   @db.VarChar(100)
  title      String?   @db.VarChar(100)
  startDate  DateTime? @map("start_date") @db.Date
  endDate    DateTime? @map("end_date") @db.Date
  isCurrent  Boolean   @default(true) @map("is_current")
  createdAt  DateTime  @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId, startDate])
  @@index([userId])
  @@index([companyId])
  @@map("company_members")
}

// Experience - User work experience (plain text company, NOT FK)
model Experience {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  company     String    @db.VarChar(200)
  title       String    @db.VarChar(200)
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  isCurrent   Boolean   @default(false) @map("is_current")
  description String?   @db.Text
  location    String?   @db.VarChar(200)
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("experiences")
}

// Education - User education history
model Education {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  institution  String   @db.VarChar(200)
  degree       String?  @db.VarChar(200)
  fieldOfStudy String?  @map("field_of_study") @db.VarChar(200)
  startYear    Int?     @map("start_year")
  endYear      Int?     @map("end_year")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("education")
}

// ============================================
// M3: MESSAGING MODELS
// ============================================

// Conversation - DM or group chat
model Conversation {
  id            String    @id @default(uuid()) @db.Uuid
  isGroup       Boolean   @default(false) @map("is_group")
  groupName     String?   @map("group_name") @db.VarChar(200)
  groupEmoji    String?   @map("group_emoji") @db.VarChar(10)
  isPublic      Boolean   @default(false) @map("is_public")
  createdBy     String?   @map("created_by") @db.Uuid
  dmKey         String?   @unique @map("dm_key") @db.VarChar(73)
  lastMessage   String?   @map("last_message") @db.Text
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  creator      User?    @relation("ConversationCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  participants ConversationParticipant[]
  messages     Message[]

  @@index([lastMessageAt])
  @@index([isPublic, isGroup, lastMessageAt])
  @@map("conversations")
}

// ConversationParticipant - User membership in a conversation
model ConversationParticipant {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  joinedAt       DateTime @default(now()) @map("joined_at")
  lastReadAt     DateTime @default(now()) @map("last_read_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

// Message - Individual message in a conversation
model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  senderId       String?  @map("sender_id") @db.Uuid
  content        String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}